% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/coxiv_seq.R
\name{coxiv_seq}
\alias{coxiv_seq}
\title{Sequential 2SRI Cox model via trial emulation with a baseline IV}
\usage{
coxiv_seq(
  formula,
  trtformula,
  data,
  id,
  trial_id = "trial",
  tvtrt,
  iv,
  stratify = TRUE,
  se_type = c("jackknife", "bootstrap", "robust", "none"),
  B = 200,
  seed = NULL,
  ipcw = TRUE,
  ipcw_trunc = 0.95,
  ipcw_den_covs = NULL,
  ipcw_num_covs = NULL,
  by_trial = FALSE,
  ...
)
}
\arguments{
\item{formula}{A survival formula of the form
\code{Surv(start, stop, event) ~ A.base + X1.base + ...}, specifying the
second–stage Cox model. The right–hand side must include the baseline
treatment term corresponding to \code{tvtrt.base}. Any additional
\code{*.base} covariates are treated as baseline confounders. The control
function \code{R.base} is added automatically if not present.}

\item{trtformula}{A formula for the first–stage treatment model, with left–hand
side equal to \code{tvtrt.base} (e.g. \code{A.base}) and right–hand side
including the IV and baseline covariates (e.g. \code{A.base ~ Z + X1.base + X2.base}).
This model is fit separately within each emulated trial to construct the
control–function residuals.}

\item{data}{A \code{seqem} object created by \code{\link[=seqem]{seqem()}}, containing the original
stacked pre–censoring data (\code{data_seqorig}) and the artificially
censored, sequential–trial–emulated data (\code{data_seqem}).}

\item{id}{Character string giving the name of the subject identifier variable.}

\item{trial_id}{Character string giving the name of the emulated trial
identifier (typically \code{"trial"} as produced by \code{\link[=seqem]{seqem()}}).}

\item{tvtrt}{Character string giving the name of the time–varying treatment
variable in the original data (e.g. \code{"A"}). The corresponding
trial–baseline term is assumed to be \code{paste0(tvtrt, ".base")}.}

\item{iv}{Character string giving the name of the baseline instrumental variable.}

\item{stratify}{Logical; if \code{TRUE}, include \code{strata(trial_id)} in the
second–stage Cox model, allowing a common treatment effect across trials
but trial–specific baseline hazards.}

\item{se_type}{Character string specifying the standard error estimator:
one of \code{"robust"}, \code{"jackknife"}, \code{"bootstrap"}, or \code{"none"}.}

\item{B}{Integer; number of bootstrap replicates when \code{se_type = "bootstrap"}.}

\item{seed}{Optional integer seed for reproducible bootstrap sampling.}

\item{ipcw}{Logical; must be \code{TRUE}. Artificial censoring weights are
required for valid 2SRI estimation under the sequential trial emulation.}

\item{ipcw_trunc}{Numeric in (0, 1]; percentile at which to truncate the
cumulative IPACW weights (e.g. \code{0.95} for 95th percentile truncation).}

\item{ipcw_den_covs}{Optional character vector naming time–varying covariates
whose leads are used in the denominator weight model. By default, derived
from the baseline confounders included in \code{formula}.}

\item{ipcw_num_covs}{Optional character vector naming baseline covariates
(as \code{*.base}) to use in the numerator weight model. By default, the
baseline confounders used in \code{formula} (excluding the treatment and IV).}

\item{by_trial}{Logical; if \code{TRUE}, in addition to the composite Cox fit,
fit separate 2SRI–adjusted Cox models within each emulated trial and store
them in \code{$fit_by_trial}.}

\item{...}{Additional arguments passed to \code{\link[survival:coxph]{survival::coxph()}} in the
second–stage fits.}
}
\value{
An object of class \code{"coxiv_seq"} with components including:
\itemize{
\item \code{coef}, \code{se}, \code{var}, \code{ci}: composite second–stage
log–hazard ratio estimates, standard errors, covariance matrix, and
95\\% confidence intervals.
\item \code{fit}: the fitted composite Cox model object.
\item \code{data_ste}: the final stacked, artificially censored dataset
used in the second–stage analysis, including the control function
\code{R.base} and the weight column indicated by \code{wt_col}.
\item \code{trtfit_by_trial}: list of first–stage treatment model fits
(one per emulated trial) for IV diagnostics.
\item \code{fit_by_trial}: if \code{by_trial = TRUE}, list of trial–specific
second–stage Cox fits.
\item \code{n_ids}, \code{n_trials}, \code{trial_values}: meta–information
on the number of subjects and emulated trials.
}
}
\description{
\code{coxiv_seq()} implements a sequential two–stage residual inclusion (2SRI)
Cox model for time‐to‐event outcomes with a \emph{time–varying} treatment
and a \emph{baseline} instrumental variable (IV), using the sequential trial
emulation framework of Gran et al. and Keogh et al.

The function takes as input a \code{seqem} object (constructed by \code{\link[=seqem]{seqem()}})
and proceeds in four key steps:

\enumerate{
\item \strong{Sequential trial emulation.}
Using the preprocessed data from \code{\link[=seqem]{seqem()}}, each individual contributes
person–time to a series of emulated trials defined by distinct treatment
initiation times. In each trial, only covariates at the trial baseline
(variables with suffix \code{.base}) are allowed to enter the models.

\item \strong{First–stage treatment models and control function.}
For each emulated trial, a logistic regression specified by \code{trtformula}
is fit for the trial–baseline treatment status (e.g. \code{A.base}) on the
baseline IV and baseline covariates. The fitted probabilities define a
trial–specific control function residual
\eqn{R\_k = A\_k^{\text{base}} - \hat{\Pr}(A\_k^{\text{base}} = 1 \mid Z, X)},
which is then mapped back to all rows within that trial as a baseline–only
covariate \code{R.base}. The collection of first–stage models is returned
in \code{$trtfit_by_trial} for IV diagnostics.

\item \strong{Artificial censoring and inverse probability weights.}
Within each emulated trial, follow–up is artificially censored at the time
of treatment switching away from the baseline treatment status. Stabilised
inverse probability artificial censoring weights (IPACW) are then estimated
via logistic models for the probability of remaining under the same
treatment, and accumulated over follow–up to form trial– and subject–specific
cumulative weights. The truncated cumulative weights are used as Cox
regression weights and are stored in the returned stacked dataset.

\item \strong{Second–stage Cox model and composite estimation.}
A weighted Cox proportional hazards model is fitted on the stacked,
artificially censored data, with the trial–baseline treatment, baseline
covariates and the control–function covariate \code{R.base} on the right–hand
side (plus optional stratification by trial). The resulting hazard–ratio
estimates are obtained under a composite–likelihood interpretation across
emulated trials. Standard errors can be obtained via robust (clustered on
subject), jackknife (leave–one–subject–out) or bootstrap resampling over
subjects. Optionally, if \code{by_trial = TRUE}, separate 2SRI–adjusted Cox
models are also fitted within each emulated trial and returned in
\code{$fit_by_trial}.
}
}
\details{
The method assumes:
\itemize{
\item a single binary time–varying treatment \code{tvtrt} that may switch
from 0 to 1 over follow–up;
\item a baseline‐only instrumental variable \code{iv} that affects treatment
assignment but, conditional on baseline covariates, has no direct
effect on the event time and is independent of unmeasured
prognostic factors;
\item all measured confounders included in the models enter as baseline
covariates (i.e. as \code{*.base} variables), and treatment is the
only time–varying predictor;
\item artificial censoring and IPACW correctly adjust for the informative
censoring induced by restricting follow–up within each emulated trial
to periods in which the observed treatment remains equal to the
trial‐baseline treatment status.
}

The function is designed to mirror the structure of \code{\link[=seqcox]{seqcox()}}, but with an
additional first–stage IV step and inclusion of the trial–specific control
function \code{R.base} in the second–stage Cox model.
}
\seealso{
\code{\link[=seqem]{seqem()}}, \code{\link[=seqcox]{seqcox()}}, \code{\link[survival:coxph]{survival::coxph()}}
}
